<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="unix/linux,nginx," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="CGI (Common Gateway Interface) defines the environment (environment variables, request-specific variables, etc.) a script will execute in, and how data is passed between the script and the web server.">
<meta name="keywords" content="unix&#x2F;linux,nginx">
<meta property="og:type" content="article">
<meta property="og:title" content="Setting up PHP hehind Nginx with FastCGI">
<meta property="og:url" content="http://eromonstersanji.github.io/2017/08/21/Setting-up-PHP-hehind-Nginx-with-FastCGI/index.html">
<meta property="og:site_name" content="EroMonsterSanji">
<meta property="og:description" content="CGI (Common Gateway Interface) defines the environment (environment variables, request-specific variables, etc.) a script will execute in, and how data is passed between the script and the web server.">
<meta property="og:image" content="http://osn18y1lj.bkt.clouddn.com/nginx-fcgi-1a.png">
<meta property="og:image" content="http://osn18y1lj.bkt.clouddn.com/nginx-fcgi-2.png">
<meta property="og:image" content="http://osn18y1lj.bkt.clouddn.com/nginx-fcgi-3.png">
<meta property="og:updated_time" content="2017-08-21T11:14:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Setting up PHP hehind Nginx with FastCGI">
<meta name="twitter:description" content="CGI (Common Gateway Interface) defines the environment (environment variables, request-specific variables, etc.) a script will execute in, and how data is passed between the script and the web server.">
<meta name="twitter:image" content="http://osn18y1lj.bkt.clouddn.com/nginx-fcgi-1a.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://eromonstersanji.github.io/2017/08/21/Setting-up-PHP-hehind-Nginx-with-FastCGI/"/>


  <title> Setting up PHP hehind Nginx with FastCGI | EroMonsterSanji </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="default">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">EroMonsterSanji</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">俺様は天才だ</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            Categories
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Setting up PHP hehind Nginx with FastCGI
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2017-08-21T18:29:35+08:00" content="2017-08-21">
              2017-08-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/unix-linux/" itemprop="url" rel="index">
                    <span itemprop="name">unix/linux</span>
                  </a>
                </span>

                
                
                  , 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/unix-linux/nginx/" itemprop="url" rel="index">
                    <span itemprop="name">nginx</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong><em>CGI</em></strong> <em>(Common Gateway Interface)</em> defines the environment (environment variables, request-specific variables, etc.) a script will execute in, and how data is passed between the script and the web server. For each request, <strong><em>CGI</em></strong> sets up the environment, spawns a running instance of the script and passes any incoming data to it, and captures and sends the script’s output to the server.</p>
<a id="more"></a>
<p><img src="http://osn18y1lj.bkt.clouddn.com/nginx-fcgi-1a.png" alt="nginx-fcgi1"></p>
<p>Of course, <strong><em>CGI</em></strong> has its pros and cons. On the pro side, CGI is language-independent, meaning scripts can be written in any programming language the developer is comfortable with (for example: Perl, C, bash, etc.), and each execution runs in isolation from the web server which prevents bugs in a script from potentially crashing the entire web stack. On the con side, a new process is created for each request which can be CPU-intensive and time-consuming.</p>
<p>FastCGI is essentially <strong><em>CGI</em></strong> with some enhancements that addresses CGI’s shortcomings. It reduces time/CPU-overhead by using a persistent process to execute scripts, and data between the web server and <strong><em>FastCGI</em></strong> is passed using sockets which encourages more-scalable service architectures (server farms and load balancing, asynchronous communication between web server and FastCGI, etc.).</p>
<p>For more information on <strong><em>FastCGI</em></strong>, check out the white paper on the <strong><em>FastCGI</em></strong> website, and for PHP’s implementation specifically check out the PHP manual.</p>
<hr>
<h2 id="Basic-Installation-and-Configuration"><a href="#Basic-Installation-and-Configuration" class="headerlink" title="Basic Installation and Configuration"></a>Basic Installation and Configuration</h2><p>To install PHP via Apt, execute the following at the command-line:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install php5-cli php5-fpm</div></pre></td></tr></table></figure>
<p>Then, to install nginx, execute:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install nginx</div></pre></td></tr></table></figure>
<p>Apt will identify the required dependencies in each case and prompt for confirmation to continue. Once granted, Apt will download and install the requested packages and their dependencies.</p>
<p><em>Ubuntu/Debian</em> places nginx’s configuration files in <code>/etc/nginx</code> and its sub-directories. Shared configuration fragments are kept in that root, and specific server setups reside in <code>sites-available</code> with symlinks <code>in sites-enabled</code> to make them active.</p>
<p>It’s a good idea to avoid editing the original configuration files, so I suggest using copies and keeping the originals pristine. This way, you can configure nginx to your liking and not worry about your efforts being over-written by Apt during future upgrades. You also have the original default configuration to refer back to if you never need to.</p>
<p>Delete the symlink in <code>sites-enabled</code>, duplicate the default file in <code>sites-available</code>, and create a new symlink.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/nginx</div><div class="line">sudo rm sites-enabled/default</div><div class="line">sudo cp sites-available/default sites-available/my-default</div><div class="line">sudo ln -s /etc/nginx/sites-available/my-default sites-enabled/default</div></pre></td></tr></table></figure>
<p>To have nginx proxy PHP requests to the FastCGI service, open the freshly duplicated configuration file and locate the section that starts with:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</div><div class="line">#</div><div class="line">#location ~ \.php$ &#123;</div></pre></td></tr></table></figure>
<p>Uncomment the location line and it’s matching close brace, the fastcgi_split_path_info line, and the lines that pertain to running with php5-fpm. When you’re done, the section should look like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</div><div class="line">#</div><div class="line">location ~ \.php$ &#123;</div><div class="line">    fastcgi_split_path_info ^(.+\.php)(/.+)$;</div><div class="line">#   # NOTE: You should have &quot;cgi.fix_pathinfo = 0;&quot; in php.ini</div><div class="line">#</div><div class="line">#   # With php5-cgi alone:</div><div class="line">#   fastcgi_pass 127.0.0.1:9000;</div><div class="line">#   # With php5-fpm:</div><div class="line">    fastcgi_pass unix:/var/run/php5-fpm.sock;</div><div class="line">    fastcgi_index index.php;</div><div class="line">    include fastcgi_params;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Save your changes, and then start nginx.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo service nginx start</div></pre></td></tr></table></figure>
<p>Connect to the server with your browser and you should see nginx’s welcome screen.</p>
<p><img src="http://osn18y1lj.bkt.clouddn.com/nginx-fcgi-2.png" alt="nginx-fcgi2"></p>
<p>The default configuration specifies <code>/usr/share/nginx/html</code> as the web root. In that directory, create a file named <code>info.php</code> with a call to `phpinfo()`` and then load it in your web browser to verify nginx can communicate with PHP. In the output, you should see the Server API listed as “FPM/FastCGI”.</p>
<p><img src="http://osn18y1lj.bkt.clouddn.com/nginx-fcgi-3.png" alt="nginx-fcgi3"></p>
<hr>
<h2 id="Additional-Configuration"><a href="#Additional-Configuration" class="headerlink" title="Additional Configuration"></a>Additional Configuration</h2><p>Congratulations! You have a basic nginx and PHP install set up and serving files! But there are a few additional configuration steps that I recommend.</p>
<h3 id="Web-Root-Permissions"><a href="#Web-Root-Permissions" class="headerlink" title="Web Root Permissions"></a>Web Root Permissions</h3><p>A quick check of the web root’s permissions shows that it’s not writable by anyone other than root. Constant <code>sudo</code>-ing grows tiresome, and tinkering around as root is generally a bad idea, so I recommend executing the following:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo adduser &lt;username&gt; www-data</div><div class="line">sudo chgrp -R www-data /usr/share/nginx/html</div><div class="line">sudo chmod -R g+rw /usr/share/nginx/html</div><div class="line">sudo chmod g+s /usr/share/nginx/html</div></pre></td></tr></table></figure>
<p><code>adduser</code> adds your username (replace <code>&lt;username&gt;</code> with your own login) to the <code>www-data</code> group, the same group that nginx runs under in the default Ubuntu install. <code>chgrp</code> recursively updates the <code>html</code> directory and its children to belong to the <code>www-data</code> group.</p>
<p>The first <code>chmod</code> command then grants read and write group privileges recursively to <code>html</code> and its children, and the second sets the SGID bit so that any files or directories created in <code>html</code> will take on the <code>www-data</code> group as its group owner. Note that the second <code>chmod</code> is not run recursively.</p>
<p>After the four commands have been run, you’ll need to reload your shell for the group association on your user account to take effect. Log out and then back in again. Once you’re in, you’ll be able to create, edit, and delete files in the web root to your heart’s content under your standard login without any escalated privileges.</p>
<h3 id="Non-existent-Scripts"><a href="#Non-existent-Scripts" class="headerlink" title="Non-existent Scripts"></a>Non-existent Scripts</h3><p>I also recommend adding a <code>try_files</code> directive somewhere in the <code>location</code> block you uncommented earlier in the configuration, like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location ~ \.php$ &#123;</div><div class="line">    fastcgi_split_path_info ^(.+\.php)(/.+)$;</div><div class="line">    try_files $uri $uri/ =404;</div><div class="line">...</div></pre></td></tr></table></figure>
<p>This protects you from a known vulnerability that results from an incorrectly configured system where nginx tries various patterns to satisfy a request. You may want to tweak the exact list of values after reading the documentation for <code>try_files</code> and take into consideration the needs of your application, but the above should provide a minimum level of protection.</p>
<h3 id="Porting-htaccess-Files"><a href="#Porting-htaccess-Files" class="headerlink" title="Porting .htaccess Files"></a>Porting .htaccess Files</h3><p>At some point you’ll want to serve an existing PHP application that was previously served by Apache, and most likely it will have some configuration details for the server either in an <code>.htaccess</code> file or in Apache’s static configuration files (mod_rewrite directives, for example). There are a couple online converters that “translate” Apache directives to nginx, and these are a good starting point in porting your configuration. But be careful not to rely on them entirely. As the saying goes, “Pasting code from the Internet into production is like chewing gum found in the street.” Familiarize yourself with nginx’s documentation and double check the converter’s output to make sure everything is in order.</p>
<hr>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>The traditional way of running PHP (Apache and mod_php) is stable and mature, and for the majority of applications is an excellent platform. But the landscape is changing, and more performant solutions like nginx are gaining widespread acceptance, even eating into Apache’s market share. In this article you saw how to configure PHP to run behind nginx with FastCGI. And with your shiny new installations ready to server your own high performance website to the masses, I wish you success!</p>
<!--original link: https://www.sitepoint.com/setting-up-php-behind-nginx-with-fastcgi/-->

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/unix-linux/" rel="tag">#unix/linux</a>
          
            <a href="/tags/nginx/" rel="tag">#nginx</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/08/20/nginx基本入门/" rel="next" title="nginx documentation">
                <i class="fa fa-chevron-left"></i> nginx documentation
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/09/20/C-11：左值引用-VS-右值引用/" rel="prev" title="C++11：左值引用 VS 右值引用">
                C++11：左值引用 VS 右值引用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Zheng SHI" />
          <p class="site-author-name" itemprop="name">Zheng SHI</p>
          <p class="site-description motion-element" itemprop="description">Personal blog</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Basic-Installation-and-Configuration"><span class="nav-number">1.</span> <span class="nav-text">Basic Installation and Configuration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Additional-Configuration"><span class="nav-number">2.</span> <span class="nav-text">Additional Configuration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Web-Root-Permissions"><span class="nav-number">2.1.</span> <span class="nav-text">Web Root Permissions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Non-existent-Scripts"><span class="nav-number">2.2.</span> <span class="nav-text">Non-existent Scripts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Porting-htaccess-Files"><span class="nav-number">2.3.</span> <span class="nav-text">Porting .htaccess Files</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Conclusion"><span class="nav-number">3.</span> <span class="nav-text">Conclusion</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zheng SHI</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  

  

  

  

  


</body>
</html>
